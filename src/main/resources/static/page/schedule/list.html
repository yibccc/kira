<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>智能排班系统</title>
	<link rel="stylesheet" href="../../plugins/element-ui/index.css">
	<link rel="stylesheet" href="../../styles/common.css">
	<link rel="stylesheet" href="../../styles/page.css">
	<link rel="stylesheet" href="../../styles/schedule1.css">
	<link rel="stylesheet" href="../../styles/schedule2.css">
	<link rel="stylesheet" href="../../styles/schedule3.css">
	<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.2.3/axios.js"></script>
	<script src="../../plugins/vue/vue.js"></script>
	<script src="../../plugins/element-ui/index.js"></script>
	<script src="../../plugins/axios/axios.min.js"></script>
	<script src="../../js/request.js"></script>
	<script src="../../api/employee.js"></script>
	<script src="../../api/schedule.js"></script>
	<script src="../../js/min.js"></script>
	<script src="../../js/demo-to-codepen.js"></script>
	<script src="../../js/index.global.js"></script>
	<script src="../../js/jquery-3.5.1.min.js"></script>

	<style>
		html, body {
			margin: 0;
			padding: 0;
			font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
			font-size: 14px;
		}
		#calendar {
			max-width: 1100px;
			margin: 40px auto;
		}
		#employee-app .notAdmin::after{
			border:0 !important;
		}
		.demo-ruleForm{
			height: 250px;
		}
		.table{
			position: absolute;
			top:250px;
			left:1px;
			width: 100%;
			table-layout: fixed;
			text-align: center;
		}

	</style>
</head>
<body>
<div class="dashboard-container" id="schedule-app">
	<div class="container">
		<div class="tableBar">
			<el-form
					ref="ruleForm"
					:model="ruleForm"
					:inline="false"
					:rules="rules"
					label-width="180px"
					class="demo-ruleForm"
					action="select.php"
					method="get"
			>
				<el-form-item
					label="请选择门店："
					prop="storeId"
				>
					<el-select
							type="primary"
							v-model="ruleForm.storeId"
							filterable
							placeholder="请选择门店"
							clearable=""
							class="storeOption"
					>
						<el-option v-for="(item,index) in storeList" :key="index" :label="item.name" :value="item.id">
						</el-option>
					</el-select>
				</el-form-item>
				<el-form-item
					label="请选择职位："
					prop="jobId"
				>
					<el-select
							v-model="ruleForm.selectJobId"
							placeholder="请选择职位"
							clearable
							class="showByJob"
					>
						<el-option v-for="(item,index) in jobList" :key="index" :label="item.name" :value="item.id"></el-option>
					</el-select>
				</el-form-item>
				<el-form-item
					prop="week"
				>
					<el-date-picker
							v-model="ruleForm.date"
							type="week"
							value-format="yyyy-MM-dd"
							format="yyyy 第 WW 周"
							placeholder="选择周"
							class="specificTime"
					>
					</el-date-picker>
				</el-form-item>
				<div class="subBox prefer buildSchedule">
					<el-form-item>
						<el-button
								type="primary"
								@click="submitForm('ruleForm')"
						>
							生成排班表
						</el-button>
					</el-form-item>
				</div>
			</el-form>

			<div class="employee_schedule table">
				<div id="calendar">
				</div>
			</div>
		</div>
	</div>
</div>

</body>
<script type="text/javascript">
	new Vue({
		el: '#schedule-app',
		data() {
			return {
				page: 1,
				pageSize: 10,
				counts: 0,
				tableData: [],
				employeeList: [],
				storeList: [],
				jobList: [],
				weekWork: [],
				weeks: [],
				maxWorkLength: 0,
				count: 0,
				ruleForm: {
					storeId: '',
					selectJobId:'',
					date: '',
				},
				scheduleList: [],
			}
		},
		computed: {
			rules(){
				return{
					'storeId':[
						{'required':true,'message':'请选择需查看的门店','trigger':'change'}
					],
					// 'week':[
					// 	{'required':true,'message':'请选择需查看的周','trigger':'blur'}
					// ]
				}
			}
		},
		created() {
			this.init()
			this.getJobsList()
			this.getStoresList()
			this.user = JSON.parse(localStorage.getItem('userInfo')).username
		},
		mounted() {},
		methods: {
			async init() {
				const params = {
					page: 1,
					pageSize: 10,
				}
			},
			//获取职位
			getJobsList() {
				getJobList().then(res => {
					if (res.code === 1) {
						this.jobList = res.data
					} else {
						this.$message.error(res.msg || '操作失败')
					}
				})
			},
			//获取门店
			getStoresList() {
				getStoreList().then(res => {
					if (res.code === 1) {
						this.storeList = res.data
					} else {
						this.$message.error(res.msg || '操作失败')
					}
				})
			},
			submitForm(formName, st) {
				this.$refs[formName].validate((valid) => {
					if (valid) {
						let params = {...this.ruleForm}
						params.storeId = this.ruleForm.storeId
						params.selectJobId = this.ruleForm.selectJobId
						params.date = this.ruleForm.date.toString()
						sessionStorage.setItem('storeIds', params.storeId)
						sessionStorage.setItem('selectJobIds', params.selectJobId)
						sessionStorage.setItem('dates', params.date)
						console.log(params)
						getSelectedInfo(params).then(res => {
							if (res.code === 1) {
								this.$message.success('确认自动生成排班表')
								this.tableData = res.data.records || []
								this.counts = res.data.total
								console.log(this.tableData)
								if (!st) {
									this.goBack()
								} else {
									this.ruleForm = {
										'storeId': '',
										'selectJobId': '',
										'date': ''
									}
								}
							} else {
								this.$message.error(res.msg || '操作失败')
							}
						}).catch(err => {
							this.$message.error('请求出错了：' + err)
						})
					}
				})
			},
			goBack() {
				window.parent.menuHandle({
					id: '4',
					url: '../../page/schedule/list.html',
					name: '排班表管理'
				}, false)
			},
		}
	})
	document.addEventListener('DOMContentLoaded', function() {
		var calendarEl = document.getElementById('calendar');
		var calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'dayGridWeek',
			//初始化本地语言
			locale: 'zh-cn',
			//设置时区为本地时区
			timeZone:'local',
			//定义日历上方显示全天信息的文本
			allDayText:'全天',
			//设置视图区域高度
			contentHeight: window.screen.height - 290,
			//初始化顶部工具栏
			headerToolbar: {
				left: 'today',
				center: 'title',
				right: 'prevYear,prev,timeGridWeek,timeGridDay,next,nextYear'
			},
			titleFormat: { // will produce something like "Tuesday, September 18, 2018"
				month: 'long',
				year: 'numeric',
				day: 'numeric',
				weekday: 'long'
			},
			//把按钮翻译为中文
			buttonText: {
				week:'周',
				today: '今天',
				day:'日',
			},
			defaultView:'agendaWeek', //初始化时的默认视图默认显示周
			firstDay:1,
			editable: true,
			selectable: true,
			navLinks:true,
			slotDuration:"00:30",//时间轴以30分钟为一刻度
			minTime:6,   //左侧时间从几点开始
			maxTime:22,   //左侧时间从几点结束
			dragRevertDuration:1000,//设置一秒如果拖拽不成功则回复原状
			eventLimit: true, //如果数据过多超过日历格子显示的高度时，多出去的数据不会将格子挤开，而是显示为 +...more ，点击后才会完整显示所有的数据
			//事件点击
			eventClick: function(info) {
				edit(info.event.title,info.event.start,info.event.end)
			},
			//日期点击
			dateClick: function(info) {
				add(info.dateStr);

			},
			// select: function(info) {
			// 	alert('selected ' + info.startStr + ' to ' + info.endStr);
			// },

			// 获取要显示的数据  返回的是json格式
			// eventSources: ["/paiban/list"],
			colors:[
				{color:'#0d6efd'},
				{color:'#4aec44'},
				{color:'#ee7470'},
				{color:'#fda50d'},
				{color:'#794ee0'},
				{color:'#0dfd8d'},
				{color:'#fa4141'},
			],

			events: function(arg, callback) {
				//此处的arg里面的参数也可以参照上面的那个info输出后进行研究，要把参数都明确什么意思
				var storeIds=sessionStorage.getItem('storeIds')
				var selectJobIds=sessionStorage.getItem('selectJobIds')
				var dates=sessionStorage.getItem('dates')
				$.ajax({
					url:"/paiban/list?storeId="+storeIds+"&date="+dates+"&selectJobId="+selectJobIds,
					type : "GET",
					data: {},
					cache:false,
					dataType: "json",
					success:function(data){
						let events = [];
						var val={}
						let item=JSON.parse(JSON.stringify(data.data))
						$.each(item.records,function(i) {
							val={
								title: item.records[i].employeeName+'-'+item.records[i].jobName,
								start: item.records[i].date+' '+item.records[i].startTime, // will be parsed
								end: item.records[i].date+' '+item.records[i].endTime,
								color: '#dc4c27',
							}
							events.push(val)
						});
						console.log("events是："+events)
						callback(events)
					},

				});
			},
			eventRender: function(info) {
				if(info.customRender=true){
					console.log('info.extendedProps.description')
					var tooltip = new Tooltip(info.el, {
						title: info.event.extendedProps.description,
						placement: 'top',
						trigger: 'hover',
						container: 'body'
					});
				}
			},

			//静态数据
			// events: [
			// 	{
			// 		title: "工作计划",
			// 		start: "2023-02-13T08:00:00+08:00",
			// 		end:"2023-02-13T10:00:00+08:00",
			// 		color: "green"
			// 	},
			// 	{
			// 		title: "技术评估",
			// 		start: "2023-03-16",
			// 		end: "2021-03-06"
			// 	},
			// 	{
			// 		"title": "开会",
			// 		"start": "2023-02-13T08:00:00",
			// 		"end": "2023-02-13T10:00:00"
			// 	},
			// 	{
			// 		"title": "做作业",
			// 		"start": "2023-02-14 08:00:00",
			// 		"end": "2023-02-14 10:00:00"
			// 	},
			// 	{
			// 		"title": "午饭时间",
			// 		"start": "2023-03-16T12:00:00+00:00"
			// 	},
			// 	{
			// 		"title": "客户回访",
			// 		"start": "2023-03-18T07:00:00+00:00",
			// 		"color": "red"
			// 	}
			// ],

			// 事件编辑长度时
			eventResize: info => {
				showInfo(info.event)
				// info.event.start  // 事件开始时间
				// info.event.end    // 事件结束时间
			},

			// 事件拖动时
			eventDrop: info => {
				showInfo(info.event)
				// info.event.start  // 事件开始时间
				// info.event.end    // 事件结束时间
			},
			//对于返回的数据，如果需要重新组织内容，则使用事件数据转换方法
			eventDataTransform: function(data) {
				data.title = data.title ;
				//  data.display='background';
				return data;
			},

		});
		calendar.render();
	});
	function add(today) {
		open({
			type:2,
			title:'增加',
			maxmin:true,

		})
	}

</script>

</html>