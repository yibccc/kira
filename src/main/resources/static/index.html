<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能排班系统</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="plugins/element-ui/index.css">
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/index.css">
    <link rel="stylesheet" href="styles/icon/iconfont.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.2.3/axios.js"></script>
    <style>
        .body{
            min-width: 1366px;
        }
        .app-main{
            height: calc(100% - 64px);
        }
        .app-main .divTmp{
            width: 100%;
            height: 100%;
        }
        .logo{
            height: 40px;
            color: #fff;
            font-size: larger;
        }
        .dropdown{
            align-items: center;
            width: 100px;
            height: 100%;
        }
        .el-dropdown-link{
            color:#fff;
            font-size: 15px;
        }
        .subBox{
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="app" id="app">
        <div class="app-wrapper openSidebar clearfix">
            <div class="sidebar-container">
                <div class="logo">智能排班系统</div>
                <el-scrollbar wrap-class="scrollbar-wrapper">
                    <el-menu
                        :default-active="defAct"
                        :unique-opened="false"
                        :collapse-transition="false"
                        background-color="#2b3c5a"
                        text-color="#bfcbd9"
                        active-text-color="#f4f4f5" 
                    >
                        <div v-for="item in menuList" :key="item.id">
                            <el-submenu :index="item.id" v-if="item.chidren && item.chidren.length>0">
                                <template slot="title">
                                    <i class="iconfont" :class="item.icon"></i>
                                    <span>{{item.name}}</span>
                                </template>
                                <el-menu-item
                                    v-for="sub in item.chidren"
                                    :index="sub.id"
                                    :key="sub.id"
                                    @click="menuHandle(sub,false)"
                                >
                                    <i :class="iconfont" :class="sub.icon"></i>
                                    <span slot="title">{{sub.name}}</span>
                                </el-menu-item>
                            </el-submenu>
                            <el-menu-item v-else :index="item.id" @click="menuHandle(item,false)">
                                <i class="iconfont" :class="item.icon"></i>
                                <span slot="title">{{item.name}}</span>
                            </el-menu-item>
                        </div>
                    </el-menu>
                </el-scrollbar>
            </div>
            <div class="main-container">
                <div class="navbar">
                    <div class="head-lable">
                        <span v-if="goBackFlag" class="goBack" @click="goBack()">
                            <img src="images/icons/back.png" alt="">返回
                        </span>
                        <span>{{headTitle}}</span>
                    </div>
                    <div class="right-menu">
                        <el-dropdown class="dropdown">
                            <div class="avatar-wrapper el-dropdown-link">{{ userInfo.username }}<i class="el-icon-arrow-down el-icon--right"></i></div>
                            <el-dropdown-menu slot="dropdown" class="dropdownitem" style="white-space: nowrap;">
                                <el-dropdown-item @click.native="pwdDialogVisible=true">修改密码</el-dropdown-item>
                                <el-dropdown-item @click.native="userDialogVisible=true">注销账号</el-dropdown-item>
                            </el-dropdown-menu>
                        </el-dropdown>
                            <el-dialog
                                title="修改密码"
                                :visible.sync="pwdDialogVisible"
                                width="30%"
                                :before-close="handleClose"
                            >
                                <div class="form">
                                    <el-form ref="pwdForm" :model="pwdForm" :rules="pwdRules">
                                        <el-form-item prop="newPassword" label="请输入新密码">
                                            <el-input v-model="pwdForm.newPassword" type="password" placeholder="请输入6-16位密码" maxlength="16"></el-input>
                                        </el-form-item>
                                        <el-form-item prop="confirmPassword" label="确认新密码">
                                            <el-input v-model="pwdForm.confirmPassword" type="password" placeholder="请再次输入新密码" maxlength="16"></el-input>
                                        </el-form-item>
                                    </el-form>
                                </div>
                                <div class="subBox">
                                    <el-button @click="pwdDialogVisible=false">
                                        取消
                                    </el-button>
                                    <el-button
                                            type="primary"
                                            @click="pwdHandle()"
                                    >
                                        提交
                                    </el-button>
                                </div>
                            </el-dialog>
                            <el-dialog
                                title="注销账号"
                                :visible.sync="userDialogVisible"
                                width="30%"
                                :before-close="handleClose"
                            >
                                <div class="deleteUser">确认是否注销该用户？</div>
                                <div class="subBox">
                                    <el-button @click="userDialogVisible=false">
                                         取消
                                    </el-button>
                                    <el-button
                                            type="primary"
                                            @click="userHandle()"
                                    >
                                        确定
                                    </el-button>
                                </div>
                            </el-dialog>
                        <!-- <div class="avatar-wrapper">{{userInfo.name}}</div> -->
                        <img src="images/icons/back.png" class="outLogin" alt="退出" @click="logout" />
                    </div>
                </div>
                <div class="app-main" v-loading="loading">
                    <div class="divTmp" v-show="loading"></div>
                    <iframe
                        id="cIframe"
                        class="c_iframe"
                        name="cIframe"
                        :src="iframeUrl"
                        width="100%"
                        height="auto"
                        frameborder="0"
                        v-show="!loading"
                        ></iframe>
                </div>
            </div>
        </div>
    </div>
<!--    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>-->
    <script src="plugins/vue/vue.js"></script>
    <script src="plugins/element-ui/index.js"></script>
    <script src="plugins/axios/axios.min.js"></script>
    <script src="js/request.js"></script>
    <script src="api/login.js"></script>
    <script src="api/register.js"></script>
</body>
    <script>
        new Vue({
            el:'#app',
            data(){
                return{
                    id:'',
                    defAct:'2',
                    menuActived:'2',
                    userInfo:{},
                    pwdDialogVisible:false,
                    userDialogVisible:false,
                    pwdForm:{
                        newPassword:'',
                        confirmPassword:''
                    },
                    menuList:[
                        {
                            id:'2',
                            name:'员工管理',
                            url:'page/employee/list.html',
                            icon:'icon-employee'
                        },
                        {
                            id:'3',
                            name:'门店管理',
                            url:'page/store/list.html',
                            icon:'icon-store'
                        },
                        {
                            id:'4',
                            name:'排班表管理',
                            url:'page/schedule/list.html',
                            icon:'icon-schedule'
                        },
                        {
                            id:'5',
                            name:'规则管理',
                            url:'page/rule/list.html',
                            icon:'icon-rule'
                        }
                    ],
                    iframeUrl:'page/employee/list.html',
                    headTitle:'员工管理',
                    goBackFlag:false,
                    loading:true,
                    timer:null,
                }
            },
            computed:{
                pwdRules(){
                    const validateNewPassword = (rule, value, callback) => {
                        if (value.length < 6 || value.length >16) {
                          callback(new Error('密码长度必须在6-16位'))
                        }else{
                            if(this.pwdForm.confirmPassword !== ''){
                                this.$refs.pwdForm.validateField('confirmPassword')
                            }
                            callback()
                        }
                    } 
                    const validateConfirmPassword = (rule,value,callback)=>{
                        if(value.length < 1){
                            callback(new Error('重复密码不能为空！'));
                        }else if(value != this.pwdForm.newPassword){
                            callback(new Error('两次输入密码不一致！'));
                        }else{
                            callback()
                        }
                    }
                    return {
                        newPassword: [{ validator: validateNewPassword, trigger: 'blur' }],
                        confirmPassword: [{ validator: validateConfirmPassword, trigger: 'blur' }],
                    }
                }
            },
            created(){
                const userInfo = window.localStorage.getItem('userInfo')
                // const id = window.localStorage.getItem('id')
                console.log(userInfo);
                // console.log(userInfo[6]);
                if (userInfo) {
                    this.userInfo = JSON.parse(userInfo)
                    // console.log(userInfo)
                    console.log(this.userInfo.id);
                }
                this.closeLoading()
            },
            beforeDestroy() {
                this.timer=null
                clearTimeout(this.timer)
            },
            mounted() {
                window.menuHandle=this.menuHandle
            },
            methods: {
                async pwdHandle(params){
                    this.id=this.userInfo.id;
                    this.$refs.pwdForm.validate((valid)=>{
                        if(valid){
                            let params = {...this.pwdForm}
                            params.password=this.pwdForm.newPassword
                            delete params.updateTime
                            editUser({'id':this.id,'password':params.password}).then(res=>{
                                if(res.code == 1){
                                    this.$message.success('修改密码成功！')
                                    this.pwdDialogVisible = false
                                    // this.handleQuery()
                                }else{
                                    this.$message.error(res.msg || '修改密码失败')
                                }
                            }).catch(err=>{
                                this.$message.error('请求出错了：'+err)
                            })
                        }
                    })
                },
                userHandle(id) {
                    this.id=this.userInfo.id
                    this.$confirm('确认注销此账号，是否继续？', '确定注销', {
                        'confirmButtonText': '确定',
                        'cancelButtonText': '取消',
                    }).then(() => {
                        deleteUser(this.id).then(res => {
                            if (res.code === 1) {
                                this.$message.success('注销成功！')
                                alert('注销成功，返回登陆页面...');
                                this.logout()
                            } else {
                                this.$message.error(res.msg || '操作失败')
                                this.userDialogVisible = false
                            }
                        }).catch(err => {
                            this.$message.error('请求出错了:' + err)
                        })
                    })
                },
                handleClose(done){
                    this.$confirm('确定关闭吗').then(() => {
                        // function(done)，done 用于关闭 Dialog
                        done();
                    }).catch(() => {
                        console.log("点击确定时触发");
                    });
                },
                logout() {
                    logoutApi().then((res)=>{
                    if(res.code === 1){
                        localStorage.removeItem('userInfo')
                        window.location.href = './page/login.html'
                    }
                    })
                },
                goBack() {
                  // window.location.href = 'javascript:history.go(-1)'
                  const menu = this.menuList.find(item=>item.id===this.menuActived)
                  // this.goBackFlag = false
                  // this.headTitle = menu.name
                  this.menuHandle(menu,false)
                },
                menuHandle(item, goBackFlag) {
                  this.loading = true
                  this.menuActived = item.id
                  this.iframeUrl = item.url
                  this.headTitle = item.name
                  this.goBackFlag = goBackFlag
                  this.closeLoading()
                },
                closeLoading(){
                  this.timer = null
                  this.timer = setTimeout(()=>{
                    this.loading = false
                  },1000)
                }
            },
        })
    </script>
</html>